<!DOCTYPE html>
<html>

<head>
  <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Introducing the WildFly MicroProfile Reactive Specifications Feature Pack</title>
  <meta name="description" content="Introducing the WildFly MicroProfile Reactive Specifications Feature Pack">
  <link rel="me" href="https://fosstodon.org/@wildflyas" />
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-40221748-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-40221748-1');
  </script>
  <script src="assets/javascript/tracking.js"></script>
  <script src="https://analytics.ossupstream.org/matomo.js" async defer></script>

</head>

<body class="Introducing the WildFly MicroProfile Reactive Specifications Feature Pack">
  <div class="content">
    <div class="header navigation">
  <div class="logo-wrapper">
    <a href="/"><img class="wf-logo" src="/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/" class="">Home</a>
        </li>
        <li>
          <a href="/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/news/" class="active">News</a>
        </li>
        <li>
          <a href="/about/" class="">About</a>
        </li>
        <li>
          <a href="/contribute/" class="">Contribute</a>
        </li>
        <li>
            <a target="_blank" href="https://docs.wildfly.org">Docs</a>
        </li>
        <li>
          <a href="/security/" class="">CVE Reporting</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

    <div class="post-page grid-wrapper">
  <div class="grid__item width-10-12">
    <h1 class="title">Introducing the WildFly MicroProfile Reactive Specifications Feature Pack</h1>
    
    
    <p class="byline">By Kabir Khan | June 18, 2020</p>
  </div>
  <div class="grid__item width-10-12 doc-content">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I am pleased to announce the 1.0.0.Beta1 release of the MicroProfile Reactive specifications feature
pack for WildFly. It offers experimental support for the following MicroProfile specifications,
which all focus on the reactive area:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/eclipse/microprofile-reactive-messaging/releases">MicroProfile Reactive Messaging 1.0</a> - this is a framework for building event-driven, data streaming and event sourcing applications using CDI. The streams, or channels, can be backed by a variety of messaging technologies. We currently ship connectors for: Apache Kafka, AMQP and MQTT.</p>
</li>
<li>
<p><a href="https://github.com/eclipse/microprofile-reactive-streams-operators/releases">MicroProfile Reactive Streams Operators 1.0</a> - Reactive Messaging is build on Reactive Streams. RSO gives you
a way to manipulate and handle those streams.</p>
</li>
<li>
<p><a href="https://github.com/eclipse/microprofile-context-propagation/releases">MicroProfile Context Propagation 1.0</a> - The traditional way of propagating state using ThreadLocals does not work well in the reactive world. Async/reactive code often creates a 'pipeline' of code blocks that get executed 'later' - in practice after the method defining them has returned. MicroProfile Context Propagation
is there to help you deal with this, so that your deferred code can still for example latch onto
the transaction initiated by the calling method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We are using the <a href="https://smallrye.io">SmallRye</a> implementations of each of these specifications.</p>
</div>
<div class="paragraph">
<p>The source code for the feature pack can be found on <a href="https://github.com/wildfly-extras/wildfly-mp-reactive-feature-pack">GitHub</a>. The README contains links to the specifications, as well as the SmallRye implementations of these and documentation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installing-the-feature-pack">Installing the feature pack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We decided to see what the interest is in using these MicroProfile Reactive specifications in WildFly before integrating them into the WildFly <a href="https://github.com/wildfly/wildfly">code</a> itself, which is why we have shipped this as a Galleon feature pack. This is something that we
plan on doing a lot more of in the future for experimental features. Galleon is a tool we have been using internally to compose the server the past several major releases of WildFly.</p>
</div>
<div class="paragraph">
<p>To install the feature pack, <a href="https://github.com/wildfly/galleon/releases">download</a> the latest version of Galleon. At the time of writing this is 4.2.5. Unzip it somewhere, and add its <code>bin/</code> folder to your path.</p>
</div>
<div class="paragraph">
<p>Next, save a copy of
<a href="{projectlink}/provision.xml">provision.xml</a> somewhere, and go to that folder in a terminal window. Then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$galleon.sh provision ./provision.xml --dir=my-wildfly</pre>
</div>
</div>
<div class="paragraph">
<p>This will take some time the first time you do it since it will download a lot of dependencies
from Maven. Once that is done, subsequent attempts will be fast.</p>
</div>
<div class="paragraph">
<p>What this command does is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provision a slimmed version (compared to the full download) of WildFly containing the relevant
parts for a server running in the cloud. The main <a href="{projectlink}/README.md">README</a> of the project repository contains more information about this part. You can adjust this file to choose
other parts of the server you may be interested in.</p>
</li>
<li>
<p>Next it provisions the full contents of the feature pack into our new server instance.</p>
</li>
<li>
<p>The provisioned server will be output in the <code>my-wildfly</code> subdirectory, and can be started via the usual <code>my-wildfly/bin/standalone.sh</code> command.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example">Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A short example of what these specs can do follows. The code snippets are inspired by the Quickstarts, so be sure to try those out!</p>
</div>
<div class="paragraph">
<p>First we have a method which generates a new price every five seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    private Random random = new Random();

    @Outgoing("generated-price")
    public Flowable&lt;Integer&gt; generate() {
        return Flowable.interval(5, TimeUnit.SECONDS)
                .map(tick -&gt; random.nextInt(100));
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Outgoing</code> annotation comes from Reactive Messaging, and specifies that the stream of generated prices will be sent to a channel called 'generated-price'. Channels may be either in-memory, or they may be backed by a messaging provider.</p>
</div>
<div class="paragraph">
<p>In this case, we have another method (it can be in another class) annotated with @Incoming, using the same 'generated-price' name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    @Incoming("generated-price")
    @Outgoing("to-kafka")
    public double process(int priceInUsd) {
        return priceInUsd * CONVERSION_RATE;
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Incoming</code> annotation tells it to listen for messages on the <code>generated-price</code> channel. There is a match with the name of the <code>@Outgoing</code> annotation in the previous example so this method will receive all the prices generated by the <code>generate()</code> method. As the name is the same in the two annotations, this becomes an in-memory stream.</p>
</div>
<div class="paragraph">
<p>The method is also annotated with an <code>@Outgoing</code> annotation so once its conversion has been done, the result is sent to the 'to-kafka' channel.</p>
</div>
<div class="paragraph">
<p>To map this channel to a Kafka stream, we need some configuration, using MicroProfile Config in a <code>microprofile-config.properties</code> that is part of the deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Selects the Kafka connector for the 'to-kafka' outgoing stream
mp.messaging.outgoing.to-kafka.connector=smallrye-kafka
# Maps the outgoing stream to the 'prices' Kafka topic
mp.messaging.outgoing.to-kafka.topic=prices
# Adds a serializer to convert the data
mp.messaging.outgoing.to-kafka.value.serializer=org.apache.kafka.common.serialization.IntegerSerializer</pre>
</div>
</div>
<div class="paragraph">
<p>Next we create a <code>Publisher</code> that reads this data from Kafka.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    @Inject
    @Channel("from-kafka") Publisher&lt;Double&gt; prices;</pre>
</div>
</div>
<div class="paragraph">
<p>This @Channel annotation on a <code>Publisher</code> is conceptually the same as if we had annotated a method with <code>@Incoming("from-kafka")</code> but allows us to do some cool tricks which we will see soon. This is not part of the current Reactive Messaging 1.0 specifaction, but will be part of 1.1. For now it is a SmallRye extension to the specification.</p>
</div>
<div class="paragraph">
<p>In our <code>microprofile-config.properties</code> that is part of the deployment we configure this channel mapping to the same Kafka stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Selects the Kafka connector for the 'from-kafka' incoming stream
mp.messaging.incoming.from-kafka.connector=smallrye-kafka
# Maps the incoming stream to the 'prices' Kafka topic
mp.messaging.incoming.from-kafka.topic=prices
# Adds a deserializer to convert the data
mp.messaging.incoming.from-kafka.value.deserializer=org.apache.kafka.common.serialization.IntegerDeserializer</pre>
</div>
</div>
<div class="paragraph">
<p>To summarise where we are at so far all the messages which got generated in our <code>generate()</code> methods got sent, via an in memory channel, to our <code>process()</code> method. The <code>process()</code> method did some conversion before sending it to a Kafka topic called 'prices'. Then we listen to that Kafka topic, and are able to publish them from our <code>prices</code> <code>Publisher</code> instance.</p>
</div>
<div class="paragraph">
<p>Now that we have the converted stream in a <code>Publisher</code> instance we can access it from the non-reactive world, e.g. in a REST endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    @GET
    @Path("/prices")
    @Produces(MediaType.SERVER_SENT_EVENTS) // denotes that server side events (SSE) will be produced
    @SseElementType(MediaType.TEXT_PLAIN) // denotes that the contained data, within this SSE, is just regular text/plain data
    public Publisher&lt;Double&gt; readThreePrices() {
        // get the next three prices from the price stream
        return ReactiveStreams.fromPublisher(prices)
                .limit(3)
                .buildRs();
    }</pre>
</div>
</div>
<div class="paragraph">
<p>To keep things simple, we will consider the above simple version of this method first. As we got the stream into a <code>Publisher</code> by using the <code>@Channel</code> annotation, we have a bridge into the 'user world' from the 'reactive world'. Otherwise we would just have a chain of <code>@Outgoing</code> and <code>@Incoming</code> annotated methods (which of course may be also useful in some cases!).</p>
</div>
<div class="paragraph">
<p>First, we use the MicroProfile Reactive Streams Operators method <code>ReactiveStreams.fromPublisher()</code> to wrap the publisher. We then specify <code>limit(3)</code> - this has the effect that once someone calls this method the stream will terminate after receiving three prices. We call <code>buildRs()</code> to return a new <code>Publisher</code> for those three items. As the messages are every five seconds the <code>readPrices()</code> method will return while our reactive stream is still receiving and re-emitting the three messages.</p>
</div>
<div class="paragraph">
<p>Next, let&#8217;s see how MicroProfile Context Propagation is useful. We will modify the above method, so that each of the three prices get stored to a database</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    @PersistenceContext(unitName = "quickstart")
    EntityManager em;

    @Transactional // This method is transactional
    @GET
    @Path("/prices")
    @Produces(MediaType.SERVER_SENT_EVENTS) // denotes that server side events (SSE) will be produced
    @SseElementType(MediaType.TEXT_PLAIN) // denotes that the contained data, within this SSE, is just regular text/plain data
    public Publisher&lt;Double&gt; readThreePrices() {
        // get the next three prices from the price stream
        return ReactiveStreams.fromPublisher(prices)
                .limit(3)
                .map(price -&gt; {
                    // Context propagation makes this block inherit the transaction of the caller
                    System.out.println("Storing price: " + price);
                    // store each price before we send them
                    Price priceEntity = new Price();
                    priceEntity.setValue(price);
                    // here we are all in the same transaction
                    // thanks to context propagation
                    em.persist(priceEntity);

                    return price;
                })
                .buildRs();
    }</pre>
</div>
</div>
<div class="paragraph">
<p>First of all we have made the method transactional, so a transaction will be started when entering the method. We then read three prices exactly the same as before, but this time we have an extra call to <code>map()</code>. Inside the <code>map()</code> block, we save each price to a database. Thanks to Context Propagation (which is integrated with Reactive Streams Operators) this happens within the transaction of the <code>readThreePrices()</code> method, although that method will have completed by the time the prices come through.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="feedback">Feedback</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re keen to hear your feedback! Please raise any issues found at <a href="https://github.com/wildfly-extras/wildfly-mp-reactive-feature-pack/issues" class="bare">https://github.com/wildfly-extras/wildfly-mp-reactive-feature-pack/issues</a>.</p>
</div>
</div>
</div>
  </div>
</div>



  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img class="wf-logo" src="/assets/img/wildfly_icons_one-color-logo.png"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">WildFly is open. All dependencies of this project are available under the <a href='https://www.gnu.org/licenses/old-licenses/lgpl-2.1.en.html' target='_blank'>LGPL 2.1</a> or compatible license.<br/><br/>This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/wildfly/wildfly.org/fork' target='_blank'>fork it</a> and show us what youâ€™ve got.</p>

    
      <div class="width-1-12 project-links">
        <strong>Navigation</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="/downloads">Downloads</a></li>
          
            <li><a href="https://docs.wildfly.org">Docs</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly">Github</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Contribute</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://issues.jboss.org/browse/WFLY">Submit a bug</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/wildfly">Join the forum</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly/fork">Fork WildFly</a></li>
          
            <li><a href="https://twitter.com/WildFlyAS">Follow us</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Get Help</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://groups.google.com/forum/#!forum/wildfly">Join the forum</a></li>
          
            <li><a href="https://wildfly.zulipchat.com/">Join Zulip Chat</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <strong>Find more Red Hat Middleware Community Projects</strong>
        <ul class="footer-links">
          
            <li><a href="https://www.apiman.io/">APIMan</a></li>
          
            <li><a href="http://arquillian.org">Arquillian</a></li>
          
            <li><a href="https://github.com/ansible-middleware/wildfly">Ansible Collection for Wildfly</a></li>
          
            <li><a href="http://byteman.jboss.org/">Byteman</a></li>
          
            <li><a href="http://capedwarf.org/">CapeDwarf</a></li>
          
            <li><a href="https://github.com/alechenninger/chronicler">Chronicler</a></li>
          
            <li><a href="https://github.com/darcy-framework">Darcy</a></li>
          
            <li><a href="http://debezium.io/">Debezium</a></li>
          
            <li><a href="https://www.drools.org/">Drools</a></li>
          
            <li><a href="http://gatein.jboss.org/">GateIn</a></li>
          
            <li><a href="http://www.hawkular.org/">Hawkular</a></li>
          
            <li><a href="http://hawt.io/">Hawtio</a></li>
          
            <li><a href="http://hibernate.org/">Hibernate</a></li>
          
            <li><a href="http://www.infinispan.org/">Infinispan</a></li>
          
            <li><a href="https://developers.redhat.com/products/codeready-studio/overview">CodeReady Studio</a></li>
          
            <li><a href="http://forge.jboss.org/">JBoss Forge</a></li>
          
            <li><a href="https://github.com/jboss-logging">JBoss Logging</a></li>
          
            <li><a href="http://jbossremoting.jboss.org/">JBoss Remoting</a></li>
          
            <li><a href="https://www.jbpm.org/">jBPM</a></li>
          
            <li><a href="https://jsfunit.jboss.org/">JSFUnit</a></li>
          
            <li><a href="https://www.keycloak.org/">Keycloak</a></li>
          
            <li><a href="http://modcluster.io/">Mod Cluster</a></li>
          
            <li><a href="http://modeshape.jboss.org/">ModeShape</a></li>
          
            <li><a href="https://www.optaplanner.org/">OptaPlanner</a></li>
          
            <li><a href="https://quarkus.io/">Quarkus</a></li>
          
            <li><a href="http://resteasy.jboss.org/">RESTEasy</a></li>
          
            <li><a href="https://riftsaw.jboss.org/">Riftsaw</a></li>
          
            <li><a href="http://savara.jboss.org/">Savara</a></li>
          
            <li><a href="https://weld.cdi-spec.org/">Weld</a></li>
          
            <li><a href="http://arquillian.org/">Shrinkwrap</a></li>
          
            <li><a href="http://snowdrop.jboss.org/">Snowdrop</a></li>
          
            <li><a href="https://switchyard.jboss.org/">Switchyard</a></li>
          
            <li><a href="https://tattletale.jboss.org/">Tattletale</a></li>
          
            <li><a href="http://teiid.jboss.org/">Teiid</a></li>
          
            <li><a href="https://wildfly-security.github.io/wildfly-elytron/">WildFly Elytron</a></li>
          
            <li><a href="https://thorntail.io/">Thorntail</a></li>
          
            <li><a href="http://wise.jboss.org/">Wise</a></li>
          
            <li><a href="https://xnio.jboss.org/">XNIO</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/img/redhat_reversed.svg"></a>
    </span>
  </div>
</div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/random-color-picker.js"></script>
  <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script>
</body>

</html>
